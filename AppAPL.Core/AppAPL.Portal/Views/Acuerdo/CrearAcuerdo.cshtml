﻿@{
ViewData["Title"] = "Creación de Acuerdo";
var usuarioActual = ViewBag.UsuarioActual as string;
}

@section Scripts {
    <script>
        window.usuarioActual = '@usuarioActual';
    </script>

    <!-- jQuery -->
    <script src="~/js/jquery-3.7.1.min.js" asp-append-version="true"></script>

    <!-- jQuery UI (Datepicker) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <!-- OJO: aquí era .s, debe ser .js -->
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>

    <!-- Localización Datepicker ES -->
    <script src="https://code.jquery.com/ui/1.13.3/i18n/datepicker-es.js"></script>

    <!-- DataTables (si lo usas) -->
    <script src="~/js/datatables.min.js" asp-append-version="true"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Script principal -->
    <script src="~/js/Acuerdo/CrearAcuerdo.js" asp-append-version="true"></script>

    <style>
        .ui-datepicker {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 0.9rem;
            z-index: 1056 !important;
        }

        .detalle-header {
            background-color: #343a40;
            color: white;
            padding: 8px 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
            border-radius: 4px;
        }

        .tabla-items-header th {
            background-color: #a4c995;
            color: #343a40;
            font-weight: bold;
            vertical-align: middle;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        /* Cabeceras Consulta/Solo Lectura - Verde */
        .custom-header-cons-bg {
            background-color: #a4c995 !important; /* Verde suave */
            color: #343a40 !important;
        }

        /* Cabeceras Editables - Amarillo */
        .custom-header-ingr-bg {
            background-color: #FFEC99 !important; /* Amarillo */
            color: #343a40 !important;
        }

        /* Cabeceras de Cálculos - Naranja */
        .custom-header-calc-bg {
            background-color: #FFBF47 !important; /* Naranja */
            color: #343a40 !important;
        }

        .tabla-items-body input[type="text"] {
            text-align: right;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            height: 28px;
            border: 1px solid #ced4da;
            border-radius: 0.2rem;
        }

        /* Reajustamos el espacio del modal y la tabla para que se vea correctamente */
        #modalConsultaItems .modal-body {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Elimina el alto mínimo y el comportamiento flex */
        #modalConsultaItems .modal-dialog {
            display: block !important;
        }

        /* Mantén el card con tamaño automático */
        #modalConsultaItems .card {
            height: auto !important;
        }

        /* Elimina márgenes en el form */
        #modalConsultaItems form {
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        /* La tabla ahora tendrá su propio scroll con altura controlada */
        #modalConsultaItems .table-responsive {
            max-height: 350px;
            overflow-y: auto;
        }

        /* El botón procesar selección no tendrá espacio extra */
        #btnseleccionar {
            margin-top: 0 !important;
        }

        /* Estilos para select múltiple */
        #filtroMarca, #filtroDivision, #filtroDepartamento, #filtroClase {
            cursor: pointer;
        }

            #filtroMarca option:hover,
            #filtroDivision option:hover,
            #filtroDepartamento option:hover,
            #filtroClase option:hover {
                background-color: #0d6efd !important;
                color: white !important;
            }

        /* Estilo para opciones seleccionadas */
        .form-select option:checked {
            background-color: #198754 !important;
            color: white !important;
            font-weight: bold;
        }

        /* Cabeceras Editables - Amarillo */
        .custom-header-ingr-bg {
            background-color: #FFEC99; /* Amarillo */
        }

        /* Cabeceras de Cálculos - Naranja */
        .custom-header-calc-bg {
            background-color: #FFBF47; /* Naranja */
        }

    </style>
}

<!-- Encabezado -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-1 mb-2 border-bottom">
    <h1 class="h4">Acuerdo - Creación</h1>
</div>

<!-- Selector tipo acuerdo -->
<div class="col-md-13">
    <label for="acuerdoTipo" class="form-label fw-bold col-form-label-sm">Tipo de Acuerdo</label>
    <select id="acuerdoTipo" class="form-select form-select-sm">
        <option value="">Cargando...</option>
    </select>
</div>

<hr />

<!-- ========================================================= -->
<!-- FORM GENERAL -->
<!-- ========================================================= -->
<form id="formGeneral" class="row g-1 mb-1 pb-1">
    <div class="col-md-3">
        <label class="form-label fw-bold col-form-label-sm">Fondos Proveedor</label>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control" id="fondoProveedorGeneral" value="Seleccione..." readonly>
            <button class="btn btn-outline-secondary" type="button"
                    data-bs-toggle="modal" data-bs-target="#modalConsultaProveedor">
                <img src="~/img/ico/search.svg" alt="Buscar">
            </button>
        </div>
        <input type="hidden" id="fondoProveedorIdGeneral">
    </div>

    <div class="col-md-2">
        <label for="fondoTipoGeneral" class="form-label fw-bold col-form-label-sm">Motivo</label>
        <select id="fondoTipoGeneral" class="form-select form-select-sm">
            <option selected>Cargando...</option>
        </select>
    </div>

    <div class="col-md-3">
        <label for="fondoDescripcionGeneral" class="form-label fw-bold col-form-label-sm">Descripción</label>
        <input type="text" class="form-control form-control-sm" id="fondoDescripcionGeneral" placeholder="Ingrese Descripción">
    </div>

    <div class="col-md-2">
        <label for="fondoFechaInicioGeneral" class="form-label fw-bold col-form-label-sm">Fecha Inicio</label>
        <div class="input-group input-group-sm">
            <input id="fondoFechaInicioGeneral" type="text" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
            <button class="btn btn-outline-secondary" type="button" id="btnFechaInicioGeneral">
                <img src="~/img/ico/calendar2-week.svg" alt="Calendario">
            </button>
        </div>
    </div>

    <div class="col-md-2">
        <label for="fondoFechaFinGeneral" class="form-label fw-bold col-form-label-sm">Fecha Fin</label>
        <div class="input-group input-group-sm">
            <input id="fondoFechaFinGeneral" type="text" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
            <button class="btn btn-outline-secondary" type="button" id="btnFechaFinGeneral">
                <img src="~/img/ico/calendar2-week.svg" alt="Calendario">
            </button>
        </div>
    </div>

    <div class="col-md-3 mt-0">
        <label for="fondoValorTotalGeneral" class="form-label fw-bold col-form-label-sm">$ Valor Total</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoValorTotalGeneral" placeholder="$ 0,00">
    </div>

    <div class="col-md-3 mt-0">
        <label for="fondoDisponibleGeneral" class="form-label fw-bold col-form-label-sm">$ Disponible</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoDisponibleGeneral" placeholder="$ 0,00" disabled>
    </div>

    <div class="col-md-3 mt-0">
        <label class="form-label fw-bold col-form-label-sm">$ Comprometido</label>
        <input type="text" class="form-control form-control-sm text-end" value="$ 0,00" disabled>
    </div>

    <div class="col-md-3 mt-0">
        <label class="form-label fw-bold col-form-label-sm">$ Liquidado</label>
        <input type="text" class="form-control form-control-sm text-end" value="$ 0,00" disabled>
    </div>

    <hr class="mt-1 mb-1" />

    <div class="col-12">
        <button type="button" class="btn btn-secondary">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarAcuerdoGeneral">Grabar</button>
    </div>
</form>

<!-- ========================================================= -->
<!-- MODAL PROVEEDORES -->
<!-- ========================================================= -->
<div class="modal fade" id="modalConsultaProveedor" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="modalConsultaProveedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xxl">
        <div class="modal-content" style="height: 90vh; max-height: 90vh;">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalConsultaProveedorLabel">Consulta de Proveedores</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body d-flex flex-column" style="height: calc(90vh - 120px);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Seleccione un Proveedor</span>
                    <input type="text" class="form-control form-control-sm" placeholder="Buscar..." style="width: 250px;">
                </div>

                <div class="table-responsive flex-grow-1 border rounded" style="overflow-y: auto;">
                    <table id="tablaProveedores" class="table table-hover table-sm table-bordered mb-0">
                        <thead class="table-success sticky-top">
                            <tr class="text-nowrap">
                                <th class="text-center align-middle" style="min-width: 70px;">Sel.</th>
                                <th class="align-middle" style="min-width: 90px;">IDFondo</th>
                                <th class="align-middle" style="min-width: 220px;">Descripción</th>
                                <th class="align-middle" style="min-width: 140px;">RUC</th>
                                <th class="align-middle" style="min-width: 220px;">Proveedor</th>
                                <th class="align-middle" style="min-width: 130px;">Tipo Fondo</th>
                                <th class="align-middle text-end" style="min-width: 120px;">$ Fondo</th>
                                <th class="align-middle" style="min-width: 120px;">Fecha Inicio</th>
                                <th class="align-middle" style="min-width: 120px;">Fecha Fin</th>
                                <th class="align-middle text-end" style="min-width: 130px;">$ Disponible</th>
                                <th class="align-middle text-end" style="min-width: 150px;">$ Comprometido</th>
                                <th class="align-middle text-end" style="min-width: 130px;">$ Liquidado</th>
                                <th class="align-middle" style="min-width: 110px;">Estado</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <nav aria-label="Navegación de páginas" class="mt-2">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Siguiente">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnAceptarProveedor">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================= -->
<!-- FORM ITEMS -->
<!-- ========================================================= -->
<form id="formItems" class="row g-1 mb-1 pb-1" style="display:none;">

    <div class="col-md-3">
        <label for="fondoTipoItems" class="form-label fw-bold col-form-label-sm">Motivo</label>
        <select id="fondoTipoItems" class="form-select form-select-sm">
            <option selected>Cargando...</option>
        </select>
    </div>

    <div class="col-md-3">
        <label for="fondoDescripcionItems" class="form-label fw-bold col-form-label-sm">Descripción</label>
        <input type="text" class="form-control form-control-sm" id="fondoDescripcionItems" placeholder="Ingrese Descripción">
    </div>

    <div class="col-md-3">
        <label for="fondoFechaInicioItems" class="form-label fw-bold col-form-label-sm">Fecha Inicio</label>
        <div class="input-group input-group-sm">
            <input id="fondoFechaInicioItems" type="text" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
            <button class="btn btn-outline-secondary" type="button" id="btnFechaInicioItems">
                <img src="~/img/ico/calendar2-week.svg" alt="Calendario">
            </button>
        </div>
    </div>

    <div class="col-md-3">
        <label for="fondoFechaFinItems" class="form-label fw-bold col-form-label-sm">Fecha Fin</label>
        <div class="input-group input-group-sm">
            <input id="fondoFechaFinItems" type="text" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
            <button class="btn btn-outline-secondary" type="button" id="btnFechaFinItems">
                <img src="~/img/ico/calendar2-week.svg" alt="Calendario">
            </button>
        </div>
    </div>

    <div class="col-md-3">
        <label class="form-label fw-bold col-form-label-sm">Proveedor - ID Fondo</label>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control" id="fondoProveedorItems" value="Seleccione..." readonly>
            <button class="btn btn-outline-secondary" type="button"
                    data-bs-toggle="modal" data-bs-target="#modalConsultaProveedor">
                <img src="~/img/ico/search.svg" alt="Buscar">
            </button>
        </div>
        <input type="hidden" id="fondoProveedorIdItems">
    </div>

    <div class="col-md-3 mt-0">
        <label class="form-label fw-bold col-form-label-sm">Proveedor - Valor Total</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoValorTotalItems" placeholder="$ 0,00" disabled>
    </div>

    <div class="col-12 mt-3">
        <div class="detalle-header">Detalle de los Artículos</div>

        <div class="d-flex align-items-center gap-3 pt-2 pb-1">
            <!-- Botón Añadir Item -->
            <button id="btnAddItem" type="button" class="btn btn-outline-primary border-0 d-flex align-items-center gap-1"
                    data-bs-toggle="modal" data-bs-target="#modalConsultaItems">
                <i class="fa-regular fa-square-plus"></i> Añadir Item
            </button>

            <!-- Botón Modificar -->
            <button id="btnModifyItem" type="button" class="btn btn-outline-warning border-0 d-flex align-items-center gap-1">
                <i class="fa-regular fa-pen-to-square"></i> Modificar
            </button>

            <!-- Botón Eliminar -->
            <button id="btnDeleteItem" type="button" class="btn btn-outline-danger border-0 d-flex align-items-center gap-1">
                <i class="fa-regular fa-trash-can"></i> Eliminar
            </button>
        </div>

        <div class="col-12">
            <div class="row p-0">
                <div class="col">
                    <div class="table-responsive small border" style="height: 220px;">
                        <table class="table table-bordered table-sm">
                            <thead class="sticky-top text-nowrap">
                                <tr class="text-center tabla-items-header">
                                    <th scope="col" style="width: 40px;">Sel.</th>
                                    <!-- Verde - Solo lectura -->
                                    <th scope="col" class="custom-header-cons-bg">Item</th>
                                    <th scope="col" class="custom-header-cons-bg">Costo</th>

                                    <!-- Amarillo - Editables -->
                                    <th scope="col" class="custom-header-ingr-bg">Unidades Limite</th>
                                    <th scope="col" class="custom-header-ingr-bg">Precio - Contado</th>
                                    <th scope="col" class="custom-header-ingr-bg">Precio - TC</th>
                                    <th scope="col" class="custom-header-ingr-bg">Precio - Crédito</th>
                                    <th scope="col" class="custom-header-ingr-bg">Aporte por Unidad - Proveedor</th>

                                    <!-- Naranja - Cálculos -->
                                    <th scope="col" class="custom-header-calc-bg">Comprometido Proveedor</th>
                                    <th scope="col" class="custom-header-calc-bg">Margen Contado</th>
                                    <th scope="col" class="custom-header-calc-bg">Margen TC</th>
                                    <th scope="col" class="custom-header-calc-bg">Margen Crédito</th>
                                </tr>
                            </thead>
                            <tbody id="tablaItemsBody" class="text-nowrap tabla-items-body">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="mt-3 mb-1" />

    <div class="col-12">
        <button type="button" class="btn btn-secondary">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarAcuerdoItems">Grabar Articulos</button>
    </div>
</form>

<!-- ========================================================= -->
<!-- MODAL AÑADIR ITEMS ARTICULOS -->
<!-- ========================================================= -->
<div class="modal fade" id="modalConsultaItems" tabindex="-1" aria-labelledby="modalConsultaItemLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

            <!-- HEADER -->
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalConsultaItemLabel">Consulta de Items</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">

                <!-- CRITERIOS DE SELECCIÓN -->
                <div class="row m-2">
                    <div class="card border-secondary p-0">
                        <div class="card-header">
                            Criterios de Seleccion
                        </div>

                        <div class="card-body">
                            <form class="row g-2">
                                <!-- MARCA -->
                                <!-- MARCA -->
                                <div class="col-md-3">
                                    <label class="form-label fw-bold col-form-label-sm text-center d-block">Marca</label>
                                    <div class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="form-check">
                                            <input class="form-check-input filtro-todas" type="checkbox" id="todasMarcas" data-target="filtroMarca">
                                            <label class="form-check-label fw-bold" for="todasMarcas">
                                                Todas
                                            </label>
                                        </div>
                                        <hr class="my-1">
                                        <div id="filtroMarca"></div>
                                    </div>
                                </div>

                                <!-- DIVISION -->
                                <div class="col-md-3">
                                    <label class="form-label fw-bold col-form-label-sm text-center d-block">División</label>
                                    <div class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="form-check">
                                            <input class="form-check-input filtro-todas" type="checkbox" id="todasDivisiones" data-target="filtroDivision">
                                            <label class="form-check-label fw-bold" for="todasDivisiones">
                                                Todas
                                            </label>
                                        </div>
                                        <hr class="my-1">
                                        <div id="filtroDivision"></div>
                                    </div>
                                </div>

                                <!-- DEPARTAMENTO -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold col-form-label-sm text-center d-block">Departamento</label>
                                    <div class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="form-check">
                                            <input class="form-check-input filtro-todas" type="checkbox" id="todosDepartamentos" data-target="filtroDepartamento">
                                            <label class="form-check-label fw-bold" for="todosDepartamentos">
                                                Todos
                                            </label>
                                        </div>
                                        <hr class="my-1">
                                        <div id="filtroDepartamento"></div>
                                    </div>
                                </div>

                                <!-- CLASE -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold col-form-label-sm text-center d-block">Clase</label>
                                    <div class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="form-check">
                                            <input class="form-check-input filtro-todas" type="checkbox" id="todasClases" data-target="filtroClase">
                                            <label class="form-check-label fw-bold" for="todasClases">
                                                Todas
                                            </label>
                                        </div>
                                        <hr class="my-1">
                                        <div id="filtroClase"></div>
                                    </div>
                                </div>

                                <!-- ARTÍCULO -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold col-form-label-sm text-center d-block">Artículo</label>
                                    <input type="text" id="filtroArticulo" class="form-control form-control-sm" placeholder="Buscar...">
                                </div>

                                <!-- BOTÓN DE PROCESAR -->
                                <div class="col-12 mt-2">
                                    <button type="button" id="btnProcesarFiltros" class="btn btn-secondary btn-sm w-100">
                                        <i class="fa-solid fa-filter"></i> Procesar Selección
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- CHECK + BUSCAR -->
                <div class="row m-2">
                    <div class="d-flex align-items-center mt-2">
                        <div class="form-check form-check-sm">
                            <input class="form-check-input" type="checkbox" id="checkTodosItems" checked>
                            <label class="form-check-label" for="checkTodosItems">Todos</label>
                        </div>

                        <div class="flex-grow-1"></div>

                        <input type="text" class="form-control w-25" placeholder="Buscar...">
                    </div>
                </div>

                <!-- TABLA -->
                <div class="row m-2">
                    <div class="table-responsive small p-1 border border-secondary" style="max-height: 300px; overflow-y: auto;">
                        <table id="tablaItemsConsulta" class="table table-hover table-bordered w-100">
                            <thead class="sticky-top table-success text-white text-nowrap">
                                <tr>
                                    <th>Sel</th>
                                    <th>Codigo</th>
                                    <th>Descripcion</th>
                                    <th>Costo</th>
                                    <th>Stock</th>
                                    <th>Optimo</th>
                                    <th>Excedente(u)</th>
                                    <th>Excedente($)</th>
                                    <th>M-0(u)</th>
                                    <th>>M-0($)</th>
                                    <th>M-1(u)</th>
                                    <th>M-1($)</th>
                                    <th>M-2(u)</th>
                                    <th>M-2($)</th>
                                    <th>Marg.Efe</th>
                                    <th>Marg.Cre</th>
                                    <th>Marg.Igu</th>
                                    <th>Precio</th>
                                    <th>Marg.Precio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" id="btnSeleccionarItems" class="btn btn-primary">Seleccionar</button>
            </div>
        </div>
    </div>
</div>
<!-- Autor: JEAN FRANCOIS CALDERON VEAS | Empresa: BMTECSA | Proyecto: SOFTWARE APL -->