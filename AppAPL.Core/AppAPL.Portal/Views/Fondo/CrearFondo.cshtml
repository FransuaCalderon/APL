@{
    ViewData["Title"] = "Creación de Fondos";
    // Viene del ViewBag que llenamos en el controlador
    var usuarioActual = ViewBag.UsuarioActual as string;
}

@section Scripts {
    <script>
        // Variable global con el usuario logueado
        window.usuarioActual = '@usuarioActual';
    </script>
    <!-- jQuery -->
    <script src="~/js/jquery-3.7.1.min.js" asp-append-version="true"></script>

    <!-- jQuery UI (para el Datepicker) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>

    <!-- Script de localización para español -->
    <script src="https://code.jquery.com/ui/1.13.3/i18n/datepicker-es.js"></script>
    <script src="~/js/datatables.min.js" asp-append-version="true"></script>

    <!-- *** ¡MODIFICADO! *** -->
    <!-- 2. Carga el archivo de la VISTA después (apuntando a CraerFondo.js) -->
    <script src="~/js/Fondo/CrearFondo.js" asp-append-version="true"></script>

    <!-- Estilo simple para que el datepicker se parezca a Bootstrap -->
    <style>
        .ui-datepicker {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 0.9rem; /* Tamaño de letra más acorde */
            z-index: 1056 !important; /* Asegura que se muestre sobre otros elementos (como modales si los usaras) */
        }
        /* Para que el check de la tabla se vea bien */
        #tablaProveedores img {
            height: 1.2em;
        }
    </style>

    <!-- *** ¡MODIFICADO! *** Script para inicializar el Datepicker en Español y con botones -->
    <script>
        $(document).ready(function () {

            // 1. Cargar la configuración regional en español
            $.datepicker.setDefaults($.datepicker.regional['es']);

            // 2. Configuración base común para ambos datepickers
            const commonOptions = {
                dateFormat: "dd/mm/yy",
                changeMonth: true,
                changeYear: true,
                showButtonPanel: true,
                beforeShow: function(input, inst) {
                    setTimeout(function() {
                        let buttonPane = $(inst.dpDiv).find(".ui-datepicker-buttonpane");

                        // Botón Borrar
                        let doneButton = buttonPane.find(".ui-datepicker-close");
                        doneButton.text("Borrar");
                        doneButton.off("click").on("click", function () {
                            $(input).val("");
                            // Si borramos fecha inicio, resetear restricción de fecha fin
                            if (input.id === "fondoFechaInicio") {
                                $("#fondoFechaFin").datepicker("option", "minDate", 1);
                            }
                            $.datepicker._hideDatepicker();
                        });

                        // Botón Hoy
                        let todayButton = buttonPane.find(".ui-datepicker-current");
                        todayButton.text("Hoy");
                    }, 1);
                }
            };

            // 3. ✅ Inicializar Fecha Inicio con minDate: 0 (hoy, no permite días anteriores)
            $("#fondoFechaInicio").datepicker({
                ...commonOptions,
                minDate: 0, // ✅ CLAVE: 0 = hoy, no permite fechas anteriores
                onSelect: function(dateText, inst) {
                    // Obtener la fecha seleccionada como objeto Date
                    const startDate = $(this).datepicker("getDate");

                    if (startDate) {
                        // Crear una nueva fecha para el Fin (Inicio + 1 día)
                        const minEndDate = new Date(startDate.getTime());
                        minEndDate.setDate(minEndDate.getDate() + 1);

                        // ✅ Actualizar el minDate del campo Fecha Fin
                        $("#fondoFechaFin").datepicker("option", "minDate", minEndDate);

                        // Si la fecha fin actual es menor o igual a la nueva fecha inicio, limpiarla
                        const currentEndDate = $("#fondoFechaFin").datepicker("getDate");
                        if (currentEndDate && currentEndDate <= startDate) {
                            $("#fondoFechaFin").val("");
                        }
                    }
                }
            });

            // 4. ✅ Inicializar Fecha Fin con minDate: 1 (mañana por defecto)
            $("#fondoFechaFin").datepicker({
                ...commonOptions,
                minDate: 1 // Por defecto mañana, se actualiza dinámicamente cuando se selecciona fecha inicio
            });

            // 5. Asignar el clic del *botón* para que abra el datepicker del *input*
            $("#btnFechaInicio").on("click", function () {
                $("#fondoFechaInicio").datepicker("show");
            });

            $("#btnFechaFin").on("click", function () {
                $("#fondoFechaFin").datepicker("show");
            });
        });
    </script>
}

<!-- Encabezado compacto -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-1 mb-2 border-bottom">
    <h1 class="h4">Fondos - Creación</h1>
</div>

<!-- Formulario compacto (g-2 y márgenes reducidos) -->
<form class="row g-1 mb-1 pb-1">

    <!-- Fila 1 -->
    <div class="col-md-2">
        <label for="fondoTipo" class="form-label fw-bold col-form-label-sm">Tipo Fondo</label>
        <!-- Este select se rellenará dinámicamente por Fondo.js -->
        <select id="fondoTipo" class="form-select form-select-sm">
            <option selected>Cargando...</option>
        </select>
    </div>
    <div class="col-md-3">
        <label for="fondoProveedor" class="form-label fw-bold col-form-label-sm">Proveedor</label>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control" id="fondoProveedor" value="Seleccione..." readonly>
            <button class="btn btn-outline-secondary" type="button" id="btnBuscarProveedorModal" data-bs-toggle="modal" data-bs-target="#modalConsultaProveedor">
                <img src="~/img/ico/search.svg" alt="Buscar">
            </button>
        </div>

        <input type="hidden" id="fondoProveedorId">

    </div>
    <div class="col-md-3">
        <label for="fondoDescripcion" class="form-label fw-bold col-form-label-sm">Descripción</label>
        <input type="text" class="form-control form-control-sm" id="fondoDescripcion" placeholder="Ingrese Descripción">
    </div>
    <div class="col-md-2">
        <label for="fondoFechaInicio" class="form-label fw-bold col-form-label-sm">Fecha Inicio</label>
        <div class="input-group input-group-sm">
            <input id="fondoFechaInicio" type="text" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
            <!-- ID agregado al botón para el script -->
            <button class="btn btn-outline-secondary" type="button" id="btnFechaInicio">
                <img src="~/img/ico/calendar2-week.svg" alt="Calendario">
            </button>
        </div>
    </div>
    <div class="col-md-2">
        <label for="fondoFechaFin" class="form-label fw-bold col-form-label-sm">Fecha Fin</label>
        <div class="input-group input-group-sm">
            <input id="fondoFechaFin" type="text" class="form-control form-control-sm" placeholder="dd/mm/aaaa">
            <!-- ID agregado al botón para el script -->
            <button class="btn btn-outline-secondary" type="button" id="btnFechaFin">
                <img src="~/img/ico/calendar2-week.svg" alt="Calendario">
            </button>
        </div>
    </div>

    <!-- Fila 2 -->
    <div class="col-md-3 mt-0">
        <label for="fondoValorTotal" class="form-label fw-bold col-form-label-sm">$ Valor Total</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoValorTotal" placeholder="$ 0,00">
    </div>
    <div class="col-md-3 mt-0">
        <label for="fondoDisponible" class="form-label fw-bold col-form-label-sm">$ Disponible</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoDisponible" placeholder="$ 0,00" disabled>
    </div>
    <div class="col-md-3 mt-0">
        <label for="fondoComprometido" class="form-label fw-bold col-form-label-sm">$ Comprometido</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoComprometido" value="$ 0.00" disabled>
    </div>
    <div class="col-md-3 mt-0">
        <label for="fondoLiquidado" class="form-label fw-bold col-form-label-sm">$ Liquidado</label>
        <input type="text" class="form-control form-control-sm text-end" id="fondoLiquidado" value="$ 0.00" disabled>
    </div>

    <hr class="mt-1 mb-1">
    <!-- Fila 3 - Botón (se quitó mt-2 para reducir espacio) -->
    <div class="col-20">
        <!-- *** ¡NUEVO! *** Se agregó el ID -->
        <button type="button" class="btn btn-primary" id="btnGuardarFondos">Grabar</button>
    </div>
</form>

<!-- =================================================================== -->
<!-- INICIO: MODAL CONSULTA DE PROVEEDORES -->
<!-- =================================================================== -->
<div class="modal fade" id="modalConsultaProveedor" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalConsultaProveedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xxl">
        <div class="modal-content" style="height: 90vh; max-height: 90vh;">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalConsultaProveedorLabel">Consulta de Proveedores</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body d-flex flex-column" style="height: calc(90vh - 120px);">
                <!-- Búsqueda -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Seleccione un Proveedor</span>
                    <input type="text" class="form-control form-control-sm" placeholder="Buscar..." style="width: 250px;">
                </div>

                <!-- Tabla -->
                <div class="table-responsive flex-grow-1 border rounded" style="overflow-y: auto;">
                    <table id="tablaProveedores" class="table table-hover table-sm table-bordered mb-0">
                        <thead class="table-success sticky-top">
                            <tr class="text-nowrap">
                                <th scope="col" class="text-center align-middle" style="min-width: 110px;">Seleccionar</th>
                                <th scope="col" class="align-middle" style="min-width: 80px;">Código</th>
                                <th scope="col" class="align-middle" style="min-width: 130px;">RUC</th>
                                <th scope="col" class="align-middle" style="min-width: 200px;">Nombre Proveedor</th>
                                <th scope="col" class="align-middle" style="min-width: 150px;">Contacto</th>
                                <th scope="col" class="align-middle" style="min-width: 200px;">Mail</th>
                                <th scope="col" class="align-middle" style="min-width: 130px;">Teléfono</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginador -->
                <nav aria-label="Navegación de páginas" class="mt-2">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active" aria-current="page">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Siguiente">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnAceptarProveedor">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Autor: JEAN FRANCOIS CALDERON VEAS | Empresa: BMTECSA | Proyecto: SOFTWARE APL -->