@{
    ViewData["Title"] = "Consulta de Promociones";
    var usuarioActual = ViewBag.UsuarioActual as string;
}

@section Scripts {
    <script>window.usuarioActual = '@usuarioActual';</script>
    <script src="~/js/jquery-3.7.1.min.js" asp-append-version="true"></script>
    <script src="~/js/Promocion/ConsultarPromocion.js" asp-append-version="true"></script>
    <script src="~/js/datatables.min.js" asp-append-version="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
}

<link rel="stylesheet" href="~/css/datatables.css" asp-append-version="true" />

<style>
    /* =====================================================
                   GRILLA ESTILO IMAGEN - CABECERA PROMOCIÓN
                ===================================================== */
    .promo-form-grid {
        border: 1px solid #ccc;
        background: #fff;
        font-size: 0.8rem;
    }

    /* Fila superior: Promoción ID */
    .promo-header-row {
        display: flex;
        align-items: center;
        border-bottom: 1px solid #ccc;
        padding: 4px 6px;
        gap: 8px;
        background: #fff;
    }

        .promo-header-row .promo-label {
            font-weight: 700;
            white-space: nowrap;
            font-size: 0.8rem;
            color: #222;
        }

        .promo-header-row .promo-id-input {
            flex: 1;
            border: 1px solid #ccc;
            padding: 3px 6px;
            font-size: 0.8rem;
            background: #f0f0f0;
            color: #333;
            border-radius: 2px;
        }

        .promo-header-row .promo-icons {
            display: flex;
            gap: 4px;
        }

        .promo-header-row .promo-icon-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #bbb;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            border-radius: 2px;
            color: #555;
            font-size: 0.8rem;
        }

    /* Sección de columnas con header+input */
    .promo-section {
        display: flex;
        border-bottom: 1px solid #ccc;
    }

        .promo-section:last-child {
            border-bottom: none;
        }

    .promo-col {
        flex: 1;
        border-right: 1px solid #ccc;
        display: flex;
        flex-direction: column;
    }

        .promo-col:last-child {
            border-right: none;
        }

    .promo-col-header {
        font-weight: 700;
        text-align: center;
        padding: 4px 6px;
        background: #fff;
        border-bottom: 1px solid #ccc;
        color: #222;
        font-size: 0.78rem;
    }

    .promo-col-value {
        padding: 3px 6px;
        background: #fff;
    }

        .promo-col-value input[type="text"],
        .promo-col-value select {
            width: 100%;
            border: 1px solid #ccc;
            padding: 3px 6px;
            font-size: 0.78rem;
            background: #f0f0f0;
            color: #333;
            border-radius: 2px;
            height: 28px;
        }

            .promo-col-value input[type="text"]:focus,
            .promo-col-value select:focus {
                outline: none;
            }

    /* Columna pequeña: % y Regalo */
    .promo-col.col-xs {
        flex: 0 0 80px;
        max-width: 80px;
    }

    .promo-col.col-sm {
        flex: 0 0 110px;
        max-width: 110px;
    }

    .promo-col.col-md {
        flex: 0 0 160px;
        max-width: 160px;
    }

    /* Columna Estado + Regalo juntos */
    .promo-col.col-estado-regalo {
        flex: 0 0 200px;
        max-width: 200px;
    }

    .estado-regalo-value {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 3px 6px;
    }

        .estado-regalo-value input[type="text"] {
            flex: 1;
            min-width: 0;
            border: 1px solid #ccc;
            padding: 3px 6px;
            font-size: 0.78rem;
            background: #f0f0f0;
            color: #333;
            border-radius: 2px;
            height: 28px;
        }

    .regalo-label {
        display: flex;
        align-items: center;
        gap: 3px;
        white-space: nowrap;
        font-size: 0.75rem;
        font-weight: 600;
        color: #333;
        cursor: default;
        margin: 0;
    }

        .regalo-label input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #0d6efd;
            margin: 0;
        }

    /* Input con icono (solo visual) */
    .input-with-icon {
        display: flex;
        gap: 0;
    }

        .input-with-icon input {
            border-right: none !important;
            border-radius: 2px 0 0 2px !important;
        }

        .input-with-icon .icon-btn {
            width: 28px;
            min-width: 28px;
            height: 28px;
            border: 1px solid #ccc;
            border-left: none;
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0 2px 2px 0;
            color: #666;
            font-size: 0.75rem;
        }

    /* Checkbox regalo alineado al centro */
    .promo-col-value.center-value {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
    }

    .promo-col-value input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #0d6efd;
        cursor: default;
    }

    /* =====================================================
                   MODAL REGISTRO DE LOG - CABECERA TABLA
                ===================================================== */
    #tablaLog thead tr:first-child th {
        background-color: #8B0000 !important;
        color: #fff;
        text-align: center;
        font-weight: bold;
        padding: 8px;
        font-size: 0.95rem;
    }

    #tablaLog thead tr:nth-child(2) th {
        background-color: #1a237e !important;
        color: #fff;
        text-align: center;
        white-space: nowrap;
    }

    /* =====================================================
                   MODAL REGISTRO DE APROBACIONES - CABECERA TABLA
                ===================================================== */
    #tablaAprobaciones thead tr:first-child th {
        background-color: #8B0000 !important;
        color: #fff;
        text-align: center;
        font-weight: bold;
        padding: 8px;
        font-size: 0.95rem;
    }

    #tablaAprobaciones thead tr:nth-child(2) th {
        background-color: #1a237e !important;
        color: #fff;
        text-align: center;
        white-space: nowrap;
    }

    /* =====================================================
                   MODAL VISOR PDF
                ===================================================== */
    #modalVisorPdf .modal-dialog {
        max-width: 90vw;
        height: 90vh;
    }

    #modalVisorPdf .modal-content {
        height: 90vh;
    }

    #modalVisorPdf .modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #modalVisorPdf .modal-header {
        background: #1a237e;
        color: #fff;
        padding: 8px 16px;
        border-bottom: none;
    }

        #modalVisorPdf .modal-header .btn-close {
            filter: invert(1);
        }

    #modalVisorPdf .modal-footer {
        padding: 6px 16px;
        border-top: 1px solid #ddd;
        background: #f8f8f8;
    }

    #pdfIframe {
        width: 100%;
        flex: 1;
        border: none;
        background: #525659;
    }

    #pdfSpinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        background: #525659;
        color: #fff;
    }

    #pdfVisorError {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        background: #f8d7da;
        color: #842029;
        font-size: 0.9rem;
        padding: 20px;
        text-align: center;
    }
</style>

<h2>Consulta - Promociones</h2>
<hr class="separador-fondos" />

<!-- ============================================
     VISTA: BANDEJA (TABLA)
============================================= -->
<div id="vistaTabla" class="table-responsive">
    <div id="tabla"></div>
</div>

<!-- ============================================
     VISTA: DETALLE DE PROMOCIÓN
============================================= -->
<div id="vistaDetalle" style="display:none;">
    <div class="card border-secondary mb-3">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-dark">Detalle de la Promoción #<span id="lblIdPromocion"></span></h5>
            <button type="button" class="btn btn-sm btn-outline-dark" id="btnVolverTabla">
                <i class="fa-solid fa-arrow-left"></i> Volver a la Bandeja
            </button>
        </div>

        <div class="card-body p-2">
            <form id="formVisualizar">

                <!-- ============================================
                     GRILLA ESTILO IMAGEN
                ============================================= -->
                <div class="promo-form-grid">

                    <!-- ═══════════════════════════════════════
                         FILA 1: ID Promoción + Iconos
                    ═══════════════════════════════════════ -->
                    <div class="promo-header-row">
                        <span class="promo-label">Promoción</span>
                        <input type="text" class="promo-id-input" id="verPromocionHeader" readonly>
                        <div class="promo-icons">
                            <div class="promo-icon-btn" id="btnVerSoporte" title="Ver Soporte" style="cursor:pointer;">
                                <i class="fa-regular fa-file-pdf"></i>
                            </div>
                            <div class="promo-icon-btn" id="btnVerLog" title="Registro de Log" style="cursor:pointer;">
                                <i class="fa-regular fa-rectangle-list"></i>
                            </div>
                            <div class="promo-icon-btn" id="btnVerAprobaciones" title="Registro de Aprobaciones" style="cursor:pointer;">
                                <i class="fa-regular fa-calendar-check"></i>
                            </div>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════
                         FILA 2: Descripción | Motivo | Inicio | Fin | Estado
                    ═══════════════════════════════════════ -->
                    <div class="promo-section">
                        <div class="promo-col">
                            <div class="promo-col-header">Descripción</div>
                            <div class="promo-col-value">
                                <input type="text" id="verDescripcion" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">Motivo</div>
                            <div class="promo-col-value">
                                <input type="text" id="verMotivo" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">Inicio: Fecha - Hora</div>
                            <div class="promo-col-value">
                                <input type="text" id="verFechaInicio" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">Fin: Fecha - Hora</div>
                            <div class="promo-col-value">
                                <input type="text" id="verFechaFin" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">Estado</div>
                            <div class="promo-col-value">
                                <input type="text" id="verEstado" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════
                         FILA 3: Marca | División | Departamento | Clase | Artículo
                    ═══════════════════════════════════════ -->
                    <div class="promo-section">
                        <div class="promo-col">
                            <div class="promo-col-header">Marca</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verMarca" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">División</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verDivision" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">Departamento</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verDepartamento" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">Clase</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verClase" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">Artículo</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verArticulo" readonly>
                                    <span class="icon-btn"><i class="fa-regular fa-square-check"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════
                         FILA 4: Canal | Grupo | Almacén | Tipo Cliente | Medio Pago
                    ═══════════════════════════════════════ -->
                    <div class="promo-section">
                        <div class="promo-col">
                            <div class="promo-col-header">Canal</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verCanal" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">Grupo</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verGrupoAlmacen" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">Almacén</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verAlmacen" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">Tipo de Cliente</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verTipoCliente" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">Medio Pago</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verMedioPago" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-list-check"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════
                         FILA 5: % Dscto Prov. | ID Acuerdo Prov. | $ Comprom. Prov. | % Dscto Prop. | ID Acuerdo Prop. | $ Comprom. Prop. | % Dscto Total | Regalo
                    ═══════════════════════════════════════ -->
                    <div class="promo-section">
                        <div class="promo-col col-xs">
                            <div class="promo-col-header">% Dscto Prov.</div>
                            <div class="promo-col-value">
                                <input type="text" id="verDsctoProv" readonly>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">ID Acuerdo Proveedor</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verIdAcuerdoProv" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-magnifying-glass"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">$ Comprometido Proveed.</div>
                            <div class="promo-col-value">
                                <input type="text" id="verComprometidoProv" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-xs">
                            <div class="promo-col-header">% Dscto Prop.</div>
                            <div class="promo-col-value">
                                <input type="text" id="verDsctoProp" readonly>
                            </div>
                        </div>
                        <div class="promo-col">
                            <div class="promo-col-header">ID Acuerdo Propio</div>
                            <div class="promo-col-value">
                                <div class="input-with-icon">
                                    <input type="text" id="verIdAcuerdoProp" readonly>
                                    <span class="icon-btn"><i class="fa-solid fa-magnifying-glass"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="promo-col col-md">
                            <div class="promo-col-header">$ Comprometido Propio</div>
                            <div class="promo-col-value">
                                <input type="text" id="verComprometidoProp" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-xs">
                            <div class="promo-col-header">% Dscto Total</div>
                            <div class="promo-col-value">
                                <input type="text" id="verDsctoTotal" readonly>
                            </div>
                        </div>
                        <div class="promo-col col-xs">
                            <div class="promo-col-header">Regalo</div>
                            <div class="promo-col-value center-value">
                                <input type="checkbox" id="verRegalo" onclick="return false;">
                            </div>
                        </div>
                    </div>

                </div>
                <!-- FIN GRILLA -->

                <hr class="mt-3 mb-2" />

                <!-- Tabla de Artículos -->
                <div class="col-12 mt-2" id="contenedor-tabla-articulos" style="display:none;"></div>

            </form>
        </div>

        <div class="card-footer text-end">
            <button type="button" class="btn btn-secondary" id="btnVolverAbajo">Cerrar</button>
        </div>
    </div>
</div>

<!-- ============================================
     MODAL: VISUALIZADOR DE PDF (SOPORTE)
============================================= -->
<div class="modal fade" id="modalVisualizadorPdf" tabindex="-1"
     aria-labelledby="modalPdfLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered"
         style="max-width: 90vw; height: 90vh;">
        <div class="modal-content d-flex flex-column" style="height: 88vh;">

            <div class="modal-header py-2">
                <h5 class="modal-title fw-bold" id="modalPdfLabel">
                    <i class="fa-regular fa-file-pdf me-2 text-danger"></i>Visualizador de Soporte
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" id="btnDescargarPdf" title="Descargar PDF">
                        <i class="fa-solid fa-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
            </div>

            <div class="modal-body p-0 d-flex flex-column flex-grow-1" style="overflow: hidden;">

                <!-- Spinner de carga -->
                <div id="pdfSpinner" class="text-center py-5">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted small">Cargando documento...</p>
                </div>

                <!-- Mensaje de error -->
                <div id="pdfError" class="alert alert-danger m-3" style="display:none;">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>
                    No se pudo cargar el archivo. Verifique que el soporte existe o intente nuevamente.
                </div>

                <!-- Contenedor PDF.js -->
                <div id="pdfViewer" style="display:none; flex:1; overflow-y:auto; background:#525659; padding:10px; min-height:0;">
                    <div id="pdfCanvasContainer" style="display:flex; flex-direction:column; align-items:center; gap:8px;"></div>
                </div>

            </div>

            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>

<!-- ============================================
     MODAL: REGISTRO DE LOG
============================================= -->
<div class="modal fade" id="modalRegistroLog" tabindex="-1" aria-labelledby="modalLogLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header py-2">
                <h5 class="modal-title fw-bold" id="modalLogLabel">
                    <i class="fa-regular fa-rectangle-list me-2"></i>Registro de Log
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body p-2">

                <div id="logSpinner" class="text-center py-4" style="display:none;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted small">Cargando registros...</p>
                </div>

                <div id="contenedorTablaLog" style="display:none;">
                    <div class="table-responsive">
                        <table id="tablaLog" class="table table-bordered table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th colspan="8">Registro de Log</th>
                                </tr>
                                <tr>
                                    <th>IdLog</th>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Opción</th>
                                    <th>Acción</th>
                                    <th>Entidad</th>
                                    <th>Tipo Proceso</th>
                                    <th>Datos</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyLog"></tbody>
                        </table>
                    </div>
                    <div id="logSinDatos" class="alert alert-info text-center mt-2" style="display:none;">
                        No se encontraron registros de log para esta promoción.
                    </div>
                </div>

            </div>

            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>

<!-- ============================================
     MODAL: REGISTRO DE APROBACIONES
============================================= -->
<div class="modal fade" id="modalRegistroAprobaciones" tabindex="-1" aria-labelledby="modalAprobacionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header py-2">
                <h5 class="modal-title fw-bold" id="modalAprobacionesLabel">
                    <i class="fa-regular fa-calendar-check me-2"></i>Registro de Aprobaciones
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body p-2">

                <div id="aprobacionesSpinner" class="text-center py-4" style="display:none;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted small">Cargando registros...</p>
                </div>

                <div id="contenedorTablaAprobaciones" style="display:none;">
                    <div class="table-responsive">
                        <table id="tablaAprobaciones" class="table table-bordered table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th colspan="8">Registro de Aprobaciones</th>
                                </tr>
                                <tr>
                                    <th>Tipo Solicitud</th>
                                    <th>Usuario Solicita</th>
                                    <th>Fecha Solicitud</th>
                                    <th>Usuario Aprobador</th>
                                    <th>Fecha Aprobación</th>
                                    <th>Nivel</th>
                                    <th>Estado</th>
                                    <th>Lote</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyAprobaciones"></tbody>
                        </table>
                    </div>
                    <div id="aprobacionesSinDatos" class="alert alert-info text-center mt-2" style="display:none;">
                        No se encontraron registros de aprobaciones para esta promoción.
                    </div>
                </div>

            </div>

            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>
